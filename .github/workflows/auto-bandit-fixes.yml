name: Auto Bandit Security Fixes

on:
  schedule:
    # Run weekly on Monday at 3 AM UTC
    - cron: '0 3 * * 1'
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write
  issues: write
  security-events: read

jobs:
  bandit-scan-and-fix:
    name: Bandit Scan and Auto-fix
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install Bandit
        run: |
          python -m pip install --upgrade pip
          pip install bandit[sarif]

      - name: Run Bandit scan
        id: bandit
        run: |
          bandit -r src/ -f json -o bandit-report.json || true
          bandit -r src/ -f sarif -o bandit-report.sarif || true
          
          # Check if issues were found
          if [ -s bandit-report.json ]; then
            ISSUES=$(python -c "import json; data=json.load(open('bandit-report.json')); print(len(data.get('results', [])))")
            echo "ISSUES_FOUND=$ISSUES" >> $GITHUB_OUTPUT
            
            if [ "$ISSUES" -gt "0" ]; then
              echo "BANDIT_ISSUES=true" >> $GITHUB_OUTPUT
            fi
          fi
        continue-on-error: true

      - name: Upload SARIF results
        if: steps.bandit.outputs.BANDIT_ISSUES == 'true'
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: bandit-report.sarif
        continue-on-error: true

      - name: Parse and categorize issues
        if: steps.bandit.outputs.BANDIT_ISSUES == 'true'
        id: parse
        run: |
          python3 << 'EOF'
          import json
          import os
          
          with open('bandit-report.json', 'r') as f:
              data = json.load(f)
          
          results = data.get('results', [])
          
          # Categorize by severity
          high = [r for r in results if r.get('issue_severity') == 'HIGH']
          medium = [r for r in results if r.get('issue_severity') == 'MEDIUM']
          low = [r for r in results if r.get('issue_severity') == 'LOW']
          
          # Write summary
          with open('bandit-summary.txt', 'w') as f:
              f.write(f"Total issues: {len(results)}\n")
              f.write(f"High: {len(high)}\n")
              f.write(f"Medium: {len(medium)}\n")
              f.write(f"Low: {len(low)}\n")
          
          # Create detailed report
          with open('bandit-details.md', 'w') as f:
              f.write("## Bandit Security Scan Results\n\n")
              f.write(f"**Total Issues**: {len(results)}\n\n")
              
              if high:
                  f.write("### ðŸ”´ High Severity Issues\n\n")
                  for issue in high[:5]:  # Limit to first 5
                      f.write(f"- **{issue.get('test_name')}** in `{issue.get('filename')}:{issue.get('line_number')}`\n")
                      f.write(f"  - {issue.get('issue_text')}\n")
                      f.write(f"  - CWE: {issue.get('issue_cwe', {}).get('id', 'N/A')}\n\n")
              
              if medium:
                  f.write("### ðŸŸ¡ Medium Severity Issues\n\n")
                  for issue in medium[:5]:  # Limit to first 5
                      f.write(f"- **{issue.get('test_name')}** in `{issue.get('filename')}:{issue.get('line_number')}`\n")
                      f.write(f"  - {issue.get('issue_text')}\n\n")
              
              if low:
                  f.write(f"### ðŸŸ¢ Low Severity Issues: {len(low)} found\n\n")
          
          print("Bandit report parsed successfully")
          EOF
        continue-on-error: true

      - name: Create issue for high severity findings
        if: steps.bandit.outputs.BANDIT_ISSUES == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            let issueBody = '## ðŸ”’ Bandit Security Scan Results\n\n';
            issueBody += 'Automated Bandit scan detected security issues in the codebase.\n\n';
            
            try {
              const details = fs.readFileSync('bandit-details.md', 'utf8');
              issueBody += details;
            } catch (e) {
              issueBody += 'Could not read detailed report. Check workflow artifacts.\n';
            }
            
            issueBody += '\n### Action Required\n\n';
            issueBody += '1. Review the security findings in the attached reports\n';
            issueBody += '2. Fix high severity issues first\n';
            issueBody += '3. Consider using `# nosec` comments only for false positives\n';
            issueBody += '4. Re-run the scan after fixes to verify\n\n';
            issueBody += '**Full Report**: Check workflow artifacts for complete JSON and SARIF reports.';
            
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ðŸ”’ Bandit detected security issues in codebase',
              body: issueBody,
              labels: ['security', 'bandit', 'automated']
            });

      - name: Upload Bandit reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: bandit-reports
          path: |
            bandit-report.json
            bandit-report.sarif
            bandit-summary.txt
            bandit-details.md

      - name: Comment success if no issues
        if: steps.bandit.outputs.BANDIT_ISSUES != 'true'
        run: |
          echo "âœ… No security issues found by Bandit scan"
